name: CI/CD DevSecOps Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  # ===========================================================================
  # Job 1: Lint PHP - V√©rification de la syntaxe
  # ===========================================================================
  php-lint:
    name:  PHP Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: Configuration PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: php-parallel-lint
          
      - name: V√©rification syntaxe PHP
        run: |
          echo "V√©rification de la syntaxe PHP..."
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
          echo " Aucune erreur de syntaxe d√©tect√©e!"

  # ===========================================================================
  # Job 2: Tests Unitaires PHPUnit
  # ===========================================================================
  phpunit-tests:
    name:  Tests PHPUnit
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: Configuration PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: xdebug
          tools: composer, phpunit
          
      - name:  Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      - name:  Installation des d√©pendances
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress
          else
            composer require --dev phpunit/phpunit ^10 --no-interaction
          fi
          
      - name: Ex√©cution des tests PHPUnit
        run: |
          echo " Ex√©cution des tests unitaires..."
          if [ -d "tests" ]; then
            ./vendor/bin/phpunit --testdox --colors=always
          else
            echo " Aucun dossier tests/ trouv√©"
          fi
          
      - name:  Rapport de couverture
        if: success()
        run: |
          echo "üìä G√©n√©ration du rapport de couverture..."
          if [ -d "tests" ]; then
            ./vendor/bin/phpunit --coverage-text || true
          fi


  sonarcloud:
    name:  SonarCloud SAST
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name:  Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour l'analyse SonarCloud
          
      - name:  Analyse SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Ismail-khlif_miniprojet-DevOps
            -Dsonar.organization=ismail-khlif
            -Dsonar.sources=.
            -Dsonar.exclusions=**/vendor/**,**/node_modules/**,**/assets/**
            -Dsonar.php.version=${{ env.PHP_VERSION }}
            
      - name:  Rapport SonarCloud
        run: |
          echo "=============================================="
          echo " RAPPORT SONARCLOUD"
          echo "=============================================="
          echo ""
          echo " Dashboard du projet:"
          echo "   https://sonarcloud.io/project/overview?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo " Issues d√©tect√©es:"
          echo "   https://sonarcloud.io/project/issues?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo " Mesures de qualit√©:"
          echo "   https://sonarcloud.io/component_measures?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo "=============================================="

  # ===========================================================================
  # Job 4: Analyse de s√©curit√© suppl√©mentaire
  # ===========================================================================
  security-check:
    name: üõ°Ô∏è Security Check
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        
      - name: Recherche de secrets expos√©s
        run: |
          echo "Recherche de secrets potentiellement expos√©s..."
          
          # Recherche de patterns sensibles
          FOUND=0
          
          # Mots de passe hardcod√©s
          if grep -r "password.*=.*['\"]" --include="*.php" . | grep -v "password.*=.*\$" | grep -v "// " | grep -v "PASSWORD_"; then
            echo "‚ö†Ô∏è Potentiels mots de passe hardcod√©s d√©tect√©s!"
            FOUND=1
          fi
          
          # Cl√©s API
          if grep -rE "(api_key|apikey|secret_key|secretkey).*=.*['\"][^'\"]+['\"]" --include="*.php" . 2>/dev/null; then
            echo "Potentielles cl√©s API d√©tect√©es!"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "Aucun secret expos√© d√©tect√©!"
          fi
          
      - name: V√©rification des fonctions dangereuses
        run: |
          echo " Recherche de fonctions PHP dangereuses..."
          
          DANGEROUS_FUNCS="eval|exec|shell_exec|system|passthru|popen|proc_open"
          
          if grep -rE "($DANGEROUS_FUNCS)\s*\(" --include="*.php" . 2>/dev/null; then
            echo " Fonctions potentiellement dangereuses d√©tect√©es!"
            echo "   V√©rifiez que ces utilisations sont s√©curis√©es."
          else
            echo "Aucune fonction dangereuse d√©tect√©e!"
          fi
          
      - name:  V√©rification injection SQL
        run: |
          echo "üîç Recherche de potentielles injections SQL..."
          
          # Recherche de requ√™tes SQL avec concat√©nation directe
          if grep -rE "SELECT.*FROM.*WHERE.*\\\$" --include="*.php" . 2>/dev/null | grep -v "prepare"; then
            echo " Potentielles injections SQL d√©tect√©es!"
            echo "   Utilisez des requ√™tes pr√©par√©es (PDO::prepare)"
          else
            echo " Pas de pattern d'injection SQL √©vident!"
          fi
          
      - name:  R√©sum√© de s√©curit√©
        run: |
          echo ""
          echo "=============================================="
          echo " R√âSUM√â DES V√âRIFICATIONS DE S√âCURIT√â"
          echo "=============================================="
          echo " V√©rifications effectu√©es:"
          echo "   - Recherche de secrets expos√©s"
          echo "   - V√©rification des fonctions dangereuses"
          echo "   - D√©tection de patterns d'injection SQL"
          echo ""
          echo "Pour une analyse DAST compl√®te, utilisez OWASP ZAP"
          echo "=============================================="

  # ===========================================================================
  # Job 5: R√©sum√© final du build
  # ===========================================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [php-lint, phpunit-tests, sonarcloud, security-check]
    if: always()
    
    steps:
      - name: R√©sum√© du pipeline
        run: |
          echo "=============================================="
          echo " R√âSUM√â DU PIPELINE CI/CD DEVSECOPS"
          echo "=============================================="
          echo ""
          echo " PHP Lint:        ${{ needs.php-lint.result }}"
          echo " PHPUnit Tests:   ${{ needs.phpunit-tests.result }}"
          echo " SonarCloud:      ${{ needs.sonarcloud.result }}"
          echo " Security Check:  ${{ needs.security-check.result }}"
          echo ""
          echo "=============================================="
          echo " Date: $(date)"
          echo " Commit: ${{ github.sha }}"
          echo " Auteur: ${{ github.actor }}"
          echo "=============================================="
