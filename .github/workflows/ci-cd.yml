# =============================================================================
# Pipeline CI/CD DevSecOps - miniprojet-DevOps
# =============================================================================
# Ce pipeline exÃ©cute automatiquement:
# - Lint PHP (vÃ©rification syntaxe)
# - Tests unitaires PHPUnit
# - Analyse SAST avec SonarCloud
# - Analyse de sÃ©curitÃ© supplÃ©mentaire
# 
# @author Ismail KHLIF, Islem BARGUI
# @version 2.0
# =============================================================================

name: CI/CD DevSecOps Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  # ===========================================================================
  # Job 1: Lint PHP - VÃ©rification de la syntaxe
  # ===========================================================================
  php-lint:
    name: ğŸ” PHP Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Configuration PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: php-parallel-lint
          
      - name: âœ… VÃ©rification syntaxe PHP
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe PHP..."
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
          echo "âœ… Aucune erreur de syntaxe dÃ©tectÃ©e!"

  # ===========================================================================
  # Job 2: Tests Unitaires PHPUnit
  # ===========================================================================
  phpunit-tests:
    name: ğŸ§ª Tests PHPUnit
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Configuration PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: xdebug
          tools: composer, phpunit
          
      - name: ğŸ“¦ Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      - name: ğŸ“¥ Installation des dÃ©pendances
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress
          else
            composer require --dev phpunit/phpunit ^10 --no-interaction
          fi
          
      - name: ğŸ§ª ExÃ©cution des tests PHPUnit
        run: |
          echo "ğŸ§ª ExÃ©cution des tests unitaires..."
          if [ -d "tests" ]; then
            ./vendor/bin/phpunit --testdox --colors=always
          else
            echo "âš ï¸ Aucun dossier tests/ trouvÃ©"
          fi
          
      - name: ğŸ“Š Rapport de couverture
        if: success()
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration du rapport de couverture..."
          if [ -d "tests" ]; then
            ./vendor/bin/phpunit --coverage-text || true
          fi

  # ===========================================================================
  # Job 3: Analyse SAST - SonarCloud
  # ===========================================================================
  sonarcloud:
    name: ğŸ”’ SonarCloud SAST
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour l'analyse SonarCloud
          
      - name: ğŸ” Analyse SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=Ismail-khlif_miniprojet-DevOps
            -Dsonar.organization=ismail-khlif
            -Dsonar.sources=.
            -Dsonar.exclusions=**/vendor/**,**/node_modules/**,**/assets/**
            -Dsonar.php.version=${{ env.PHP_VERSION }}
            
      - name: ğŸ“‹ Rapport SonarCloud
        run: |
          echo "=============================================="
          echo "ğŸ“Š RAPPORT SONARCLOUD"
          echo "=============================================="
          echo ""
          echo "ğŸ”— Dashboard du projet:"
          echo "   https://sonarcloud.io/project/overview?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo "ğŸ› Issues dÃ©tectÃ©es:"
          echo "   https://sonarcloud.io/project/issues?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo "ğŸ“ˆ Mesures de qualitÃ©:"
          echo "   https://sonarcloud.io/component_measures?id=Ismail-khlif_miniprojet-DevOps"
          echo ""
          echo "=============================================="

  # ===========================================================================
  # Job 4: Analyse de sÃ©curitÃ© supplÃ©mentaire
  # ===========================================================================
  security-check:
    name: ğŸ›¡ï¸ Security Check
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ” Recherche de secrets exposÃ©s
        run: |
          echo "ğŸ” Recherche de secrets potentiellement exposÃ©s..."
          
          # Recherche de patterns sensibles
          FOUND=0
          
          # Mots de passe hardcodÃ©s
          if grep -r "password.*=.*['\"]" --include="*.php" . | grep -v "password.*=.*\$" | grep -v "// " | grep -v "PASSWORD_"; then
            echo "âš ï¸ Potentiels mots de passe hardcodÃ©s dÃ©tectÃ©s!"
            FOUND=1
          fi
          
          # ClÃ©s API
          if grep -rE "(api_key|apikey|secret_key|secretkey).*=.*['\"][^'\"]+['\"]" --include="*.php" . 2>/dev/null; then
            echo "âš ï¸ Potentielles clÃ©s API dÃ©tectÃ©es!"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "âœ… Aucun secret exposÃ© dÃ©tectÃ©!"
          fi
          
      - name: ğŸ”’ VÃ©rification des fonctions dangereuses
        run: |
          echo "ğŸ” Recherche de fonctions PHP dangereuses..."
          
          DANGEROUS_FUNCS="eval|exec|shell_exec|system|passthru|popen|proc_open"
          
          if grep -rE "($DANGEROUS_FUNCS)\s*\(" --include="*.php" . 2>/dev/null; then
            echo "âš ï¸ Fonctions potentiellement dangereuses dÃ©tectÃ©es!"
            echo "   VÃ©rifiez que ces utilisations sont sÃ©curisÃ©es."
          else
            echo "âœ… Aucune fonction dangereuse dÃ©tectÃ©e!"
          fi
          
      - name: ğŸ” VÃ©rification injection SQL
        run: |
          echo "ğŸ” Recherche de potentielles injections SQL..."
          
          # Recherche de requÃªtes SQL avec concatÃ©nation directe
          if grep -rE "SELECT.*FROM.*WHERE.*\\\$" --include="*.php" . 2>/dev/null | grep -v "prepare"; then
            echo "âš ï¸ Potentielles injections SQL dÃ©tectÃ©es!"
            echo "   Utilisez des requÃªtes prÃ©parÃ©es (PDO::prepare)"
          else
            echo "âœ… Pas de pattern d'injection SQL Ã©vident!"
          fi
          
      - name: ğŸ“‹ RÃ©sumÃ© de sÃ©curitÃ©
        run: |
          echo ""
          echo "=============================================="
          echo "ğŸ“‹ RÃ‰SUMÃ‰ DES VÃ‰RIFICATIONS DE SÃ‰CURITÃ‰"
          echo "=============================================="
          echo "âœ… VÃ©rifications effectuÃ©es:"
          echo "   - Recherche de secrets exposÃ©s"
          echo "   - VÃ©rification des fonctions dangereuses"
          echo "   - DÃ©tection de patterns d'injection SQL"
          echo ""
          echo "ğŸ’¡ Pour une analyse DAST complÃ¨te, utilisez OWASP ZAP"
          echo "=============================================="

  # ===========================================================================
  # Job 5: RÃ©sumÃ© final du build
  # ===========================================================================
  build-summary:
    name: ğŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [php-lint, phpunit-tests, sonarcloud, security-check]
    if: always()
    
    steps:
      - name: ğŸ“Š RÃ©sumÃ© du pipeline
        run: |
          echo "=============================================="
          echo "ğŸ“Š RÃ‰SUMÃ‰ DU PIPELINE CI/CD DEVSECOPS"
          echo "=============================================="
          echo ""
          echo "ğŸ” PHP Lint:        ${{ needs.php-lint.result }}"
          echo "ğŸ§ª PHPUnit Tests:   ${{ needs.phpunit-tests.result }}"
          echo "ğŸ”’ SonarCloud:      ${{ needs.sonarcloud.result }}"
          echo "ğŸ›¡ï¸ Security Check:  ${{ needs.security-check.result }}"
          echo ""
          echo "=============================================="
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
          echo "=============================================="
